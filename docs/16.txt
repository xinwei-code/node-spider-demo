
    æ ‡é¢˜ï¼špuppeteer çš„å®ç°åŸç†

    æ­£æ–‡å†…å®¹ï¼š
    <p>hi allï¼Œåˆ†äº«ä¸€ä¸ª puppeteer çš„ debug, æ›´å¤šå¯ä»¥æŒç»­å…³æ³¨ ğŸŒŸ <a href="https://github.com/xiaoxiaojx/blog/issues/21">github | blog</a> ğŸŒŸ</p>
<p><img src="https://user-images.githubusercontent.com/23253540/141687452-54214127-5297-47aa-907b-1ca99580e5fb.png" alt="image"></p>
<h2>èƒŒæ™¯</h2>
<p>æœ‰åŒå­¦åæ§½æ•´ä¸ª CI/CD ä¸‹æ¥æ—¶é—´å¤ªé•¿äº†, å…¶ä¸­ e2e æµ‹è¯•èŠ‚ç‚¹å°±èŠ±äº† 10 åˆ†é’Ÿ ğŸ¢</p>
<p>ç°åœ¨æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ puppeteer è¿›è¡Œçš„ä¸€ä¸ªè‡ªåŠ¨åŒ– e2e æµ‹è¯•, è¯¥èŠ‚ç‚¹æ˜¯åœ¨æ­£å¼å‘å¸ƒå‰, é¢„å‘å‘å¸ƒåã€‚</p>
<p>ä½œä¸ºä¸€ä¸ªæ‰€æœ‰é¡¹ç›®éƒ½å¿…é¡»è¦é€šè¿‡çš„ä¸€ä¸ªèŠ‚ç‚¹, å®ƒä¸»è¦çš„åŠŸèƒ½æ˜¯è¯»å–é¡¹ç›®ä¸­çš„æ‰€æœ‰è·¯ç”±é¡µé¢è¿›è¡Œä¸€ä¸ªç™½å±æµ‹è¯•ä¸æ£€æŸ¥æ˜¯å¦æœ‰ console.error ã€ç½‘ç»œé”™è¯¯ç­‰ã€‚</p>
<h2>æ’æŸ¥</h2>
<p>æ”¶åˆ°åé¦ˆåé¦–å…ˆæ˜¯è¿›è¡Œæ’æŸ¥, å‘ç°è¯¥ spa é¡¹ç›®å…± 96 ä¸ª âš ï¸ è·¯ç”±é¡µé¢, è€Œåªä¼šå¼€å¯ âš ï¸ ä¸€ä¸ª  puppeteer browser å®ä¾‹å»é€ä¸ªå¯¹é¡µé¢æµ‹è¯•å¯¼è‡´äº†è€—æ—¶è¿‡é•¿ã€‚</p>
<p>ä¸€å¼€å§‹ä¹Ÿæ²¡æœ‰ç€æ€¥å»æ”¹, è€Œæ˜¯é—®ç¬¬ä¸€ç‰ˆå¼€å‘ e2e çš„å¤§ä½¬, ä¸ºä½•æ²¡æœ‰å¼€å¯å¤šä¸ª browser å®ä¾‹å»å¹¶è¡Œå®Œæˆè¿™äº›è·¯ç”±é¡µé¢çš„ä»»åŠ¡, å¾—åˆ°çš„åé¦ˆæ˜¯å½“æ—¶é¡¹ç›®è¿˜æ¯”è¾ƒå°, å°±æ²¡æœ‰åšè¿™æ–¹é¢çš„ä¼˜åŒ–äº†ã€‚</p>
<h2>è§£å†³</h2>
<p>çœ‹æ ·å­å¤šä¸ªå®ä¾‹ä¸æ˜¯å› ä¸ºæœ‰å‘æ‰æ²¡åš, å½“æ—¶å¯èƒ½åªæ˜¯ä¸æƒ³ Overdesignã€‚è§£å†³è¿™ä¸ªé—®é¢˜æ¯”è¾ƒç®€å•æŠŠæ”¶åˆ°çš„è‹¥å¹²ä¸ªä»»åŠ¡è¿›è¡Œåˆ†ç»„, ç„¶åå»å¼€å¯å¤šä¸ª browser å®ä¾‹å»å¹¶è¡Œå®Œæˆè¿™äº›ä»»åŠ¡å³å¯ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/23253540/141813341-7e983b3f-cfe3-455e-9d8f-1ccc340f787e.png" alt="æœªå‘½åæ–‡ä»¶ (1)"></p>
<blockquote>
<p>å¦‚ä¸Šå›¾, æœ€ååˆ†ä¸º 5 ä¸ªå®ä¾‹å»å¹¶å‘å®Œæˆ, å°†è¯¥èŠ‚ç‚¹è€—æ—¶å‡å°‘åˆ°äº† 3åˆ†25 ç§’ã€‚</p>
</blockquote>
<p>è¿™é‡Œè¯´æ˜çš„ä¸€ç‚¹åˆ†çš„ç»„ä¸æ˜¯è¶Šå¤šè¶Šå¥½, æ¯”å¦‚ 96 ä¸ªä»»åŠ¡æ¯ç»„æœ€å¤§ 20ä¸ªåˆ†ä¸º 5 ç»„, æ€»æ—¶é•¿å¹¶ä¸ä¼šå‡å°‘ 5 å€ã€‚å› ä¸º browser å®ä¾‹è¶Šå¤šå ç”¨çš„ç³»ç»Ÿèµ„æºä¹Ÿä¼šè¶Šå¤šã€‚è¿™æœ‰ç‚¹åƒå°å­¦æ±‚æœ€ä¼˜è§£çš„é¢˜, éšç€åˆ†ç»„æ•°é‡(x è½´)çš„å¢é•¿, æ€»è€—æ—¶(y è½´)ä¼šç±»ä¼¼äºä¸€ä¸ªæŠ›ç‰©çº¿ã€‚</p>
<h2>puppeteer</h2>
<p>å…¶å® puppeteer å·²ç»åº”ç”¨åœ¨æˆ‘ä»¬å¾ˆå¤šçš„å‰ç«¯é¢†åŸŸ, å¦‚ä¸Šé¢æ‰€è¯´çš„ e2e æµ‹è¯•, å…¶ä»–è¯¸å¦‚çˆ¬è™«ã€é¡µé¢å®šæ—¶å·¡æ£€ã€é¡µé¢æ€§èƒ½ç›‘æ§éƒ½æ˜¯ä½¿ç”¨çš„ puppeteerã€‚</p>
<p>æœ¬æ¬¡å°±å¾ˆå¿«è§£å†³äº†è¿™ä¸ªé—®é¢˜, å‡ºäºå¥½å¥‡ä¹Ÿç²—ç•¥çš„å»å­¦ä¹ äº†ä¸€ä¸‹ puppeteer çš„å®ç°åŸç†ã€‚</p>
<pre class="prettyprint"><code>const puppeteer = require('puppeteer');

(async () =&gt; {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  await page.goto('https://example.com');
  await page.screenshot({ path: 'example.png' });

  await browser.close();
})();
</code></pre><h3>æ–°çš„ browser å®ä¾‹å®ç°</h3>
<ol>
<li>é€šè¿‡ childProcess.spawn è¿è¡Œ chromium çš„å¯æ‰§è¡Œæ–‡ä»¶, æ‰“å¼€ä¸€ä¸ª chromium browser</li>
<li>ç»‘å®šä¸€äº›äº‹ä»¶ç›‘å¬</li>
</ol>
<pre class="prettyprint"><code>// src/node/BrowserRunner.ts

start(options: LaunchOptions): void {
    //...

    this.proc = childProcess.spawn(
      this._executablePath,
      this._processArguments,
      {
        // On non-windows platforms, `detached: true` makes child process a
        // leader of a new process group, making it possible to kill child
        // process tree with `.kill(-pid)` command. @see
        // https://nodejs.org/api/child_process.html#child_process_options_detached
        detached: process.platform !== 'win32',
        env,
        stdio,
      }
    );
    
    // ...
    
    this._listeners = [
      helper.addEventListener(process, 'exit', this.kill.bind(this)),
    ];
    if (handleSIGINT)
      this._listeners.push(
        helper.addEventListener(process, 'SIGINT', () =&gt; {
          this.kill();
          process.exit(130);
        })
      );
    if (handleSIGTERM)
      this._listeners.push(
        helper.addEventListener(process, 'SIGTERM', this.close.bind(this))
      );
    if (handleSIGHUP)
      this._listeners.push(
        helper.addEventListener(process, 'SIGHUP', this.close.bind(this))
      );
  }
</code></pre><h3>browser çš„å¯åŠ¨æµç¨‹</h3>
<ol>
<li>é€šè¿‡ä¸Šé¢çš„ start å‡½æ•°ä¸­èµ‹å€¼çš„ this.proc è·å–æ–°æ‰“å¼€çš„ chromium è¿›ç¨‹å¥æŸ„, å³è¯¥å‡½æ•°çš„å…¥å‚ browserProcess</li>
<li>é€šè¿‡ readline.createInterface ä»¥åŠ browserProcess.stderr è·å– chromium è¿›ç¨‹çš„æ—¥å¿—è¾“å‡º, è¿™é‡Œæ˜¯é€šè¿‡ readline å»è·å–å­è¿›ç¨‹çš„è¾“å‡ºä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒå°‘è§çš„ç”¨æ³•</li>
<li>å½“ç›‘å¬åˆ° /^DevTools listening on (ws://.*)$/ åŒ¹é…çš„æ—¥å¿—å, å³ç®—è·å–åˆ°äº† chromium è¿›ç¨‹ä¸Šçš„ WebSocket è¿è¡Œçš„ url</li>
</ol>
<pre class="prettyprint"><code>// src/node/BrowserRunner.ts

function waitForWSEndpoint(
  browserProcess: childProcess.ChildProcess,
  timeout: number,
  preferredRevision: string
): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const rl = readline.createInterface({ input: browserProcess.stderr });
    let stderr = '';
    const listeners = [
      helper.addEventListener(rl, 'line', onLine),
      helper.addEventListener(rl, 'close', () =&gt; onClose()),
      helper.addEventListener(browserProcess, 'exit', () =&gt; onClose()),
      helper.addEventListener(browserProcess, 'error', (error) =&gt;
        onClose(error)
      ),
    ];
    const timeoutId = timeout ? setTimeout(onTimeout, timeout) : 0;

    /**
     * @param {!Error=} error
     */
    function onClose(error?: Error): void {
      cleanup();
      reject(
        new Error(
          [
            'Failed to launch the browser process!' +
              (error ? ' ' + error.message : ''),
            stderr,
            '',
            'TROUBLESHOOTING: https://github.com/puppeteer/puppeteer/blob/main/docs/troubleshooting.md',
            '',
          ].join('\n')
        )
      );
    }

    function onTimeout(): void {
      cleanup();
      reject(
        new TimeoutError(
          `Timed out after ${timeout} ms while trying to connect to the browser! Only Chrome at revision r${preferredRevision} is guaranteed to work.`
        )
      );
    }

    function onLine(line: string): void {
      stderr += line + '\n';
      const match = line.match(/^DevTools listening on (ws:\/\/.*)$/);
      if (!match) return;
      cleanup();
      resolve(match[1]);
    }

    function cleanup(): void {
      if (timeoutId) clearTimeout(timeoutId);
      helper.removeEventListeners(listeners);
    }
  });
</code></pre><h3>ä¸ browser é€šä¿¡</h3>
<p>ä¸Šé¢ waitForWSEndpoint å‡½æ•°è·å–åˆ°æ–°æ‰“å¼€çš„ chromium è¿›ç¨‹çš„ WebSocket ç›‘å¬çš„ url å, è¿™é‡Œå°±é€šè¿‡ ws è¿™ä¸ª npm åŒ…ç”Ÿæˆäº†ä¸€ä¸ª  NodeWebSocketã€‚</p>
<p><strong><em>åˆ°è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†æä¾›è‹¥å¹²ä¸ª api çš„ puppeteer åŸæ¥æ˜¯ä¸€ä¸ª WebSocket å®¢æˆ·ç«¯, å¦ä¸€ç«¯æ˜¯ chromium è¿›ç¨‹è¿›è¡ŒçœŸå®çš„æ“ä½œã€‚</em></strong></p>
<pre class="prettyprint"><code>// src/node/NodeWebSocketTransport.ts

import NodeWebSocket from 'ws';

export class NodeWebSocketTransport implements ConnectionTransport {
  static create(url: string): Promise&lt;NodeWebSocketTransport&gt; {
    // eslint-disable-next-line @typescript-eslint/no-var-requires
    const pkg = require('../../../../package.json');
    return new Promise((resolve, reject) =&gt; {
      const ws = new NodeWebSocket(url, [], {
        followRedirects: true,
        perMessageDeflate: false,
        maxPayload: 256 * 1024 * 1024, // 256Mb
        headers: {
          'User-Agent': `Puppeteer ${pkg.version}`,
        },
      });

      ws.addEventListener('open', () =&gt;
        resolve(new NodeWebSocketTransport(ws))
      );
      ws.addEventListener('error', reject);
    });
  }
</code></pre><h3>é€šä¿¡åè®®</h3>
<p>ä»¥æµè§ˆå™¨æ–°æ‰“å¼€ä¸€ä¸ªé¡µé¢ newPage å‡½æ•°çš„å®ç°ä¸ºä¾‹, å¯çŸ¥æ˜¯é€šè¿‡ NodeWebSocket å‘é€äº†ä¸€ä¸ª â€˜Target.createTargetâ€™ äº‹ä»¶, å¯ä¼ å‚æ•°è§ä¸‹é¢çš„ DevTools Protocol</p>
<pre class="prettyprint"><code>//src/common/Browser.ts

newPage(): Promise&lt;Page&gt; {
    return this._browser._createPageInContext(this._id);
}
  
async _createPageInContext(contextId?: string): Promise&lt;Page&gt; {
    const { targetId } = await this._connection.send('Target.createTarget', {
      url: 'about:blank',
      browserContextId: contextId || undefined,
    });
    const target = this._targets.get(targetId);
    assert(
      await target._initializedPromise,
      'Failed to create target for page'
    );
    const page = await target.page();
    return page;
  }
</code></pre><p>è¿™é‡Œç”¨æ¥æ“æ§ chromium çš„åè®®éƒ½å¯ä»¥åœ¨è¿™é‡ŒæŸ¥é˜… <a href="https://chromedevtools.github.io/devtools-protocol/tot/Target/#method-createTarget">Chrome DevTools Protocol</a></p>
<p><img src="https://user-images.githubusercontent.com/23253540/141687355-5c8e4971-117b-4bef-acf5-0491ea1a228b.png" alt="image"></p>
<h2>å°ç»“</h2>
<p>å‘ç°é—®é¢˜åæœ€å¥½å…ˆè¿½æœ¬æº¯æº, ä»¥å…èµ°å‰äººè¸©è¿‡çš„å‘ã€‚å…¶æ¬¡æœ‰å¤šä½™çš„æ—¶é—´ä¹Ÿä¸å¦¨æ¢ç©¶ä¸€ä¸‹å…¶å®ç°åŸç†, æŠ€æœ¯å…¶å®éƒ½æ˜¯ç›¸é€šçš„, çœ‹çš„å¤šäº†æ€»æ˜¯èƒ½ä¸¾ä¸€åä¸‰ ~</p>

    